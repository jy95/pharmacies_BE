name: "Fetch recent pharmacies from AFMPS"
on:
  schedule:
    # Each day at 5:00PM
    - cron: '0 17 * * *'
  # Trigger fetch on demand
  repository_dispatch:
    types: [fetch-latest-pharmacies]
  workflow_dispatch:
jobs:
  pull_data:
    runs-on: ubuntu-20.04
    steps:
      - name: 🛎️ Checkout
        uses: actions/checkout@v2
      - name: 🔨 Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: 🚧 Install dependencies
        run: pip3 install -r requirements.txt
      - name: 🤖 Fetch pharmacies from AFMPS
        run: python3 pharmaciesFromAFMPS.py
      - name: 📄 Retrieve modified or new JSON file
        uses: dorny/paths-filter@v2
        id: git_diff
        with:
          base: HEAD
          ref: ${{ github.ref }}
          token: ${{ github.token }}
          list-files: "shell"
          filters: |
            data:
              - added|modified: 'data_afmps/*.json'
# Maximal one file should match criteria
# Maybe later improve the updateStats.py to take multiple arguments ?
      - name: ✨ Update statistics file
        if: ${{ steps.git_diff.outputs.data == 'true' }}
        run: python3 updateStats.py -i ${{ steps.git_diff.outputs.data_files }}
      - name: 🔄 Update last-pharmacies file
        if: ${{ steps.git_diff.outputs.data == 'true' }}
        run: python3 generateLastPharmacies.py
      - name: ✉️ Commit new files to Github
        if: ${{ steps.git_diff.outputs.data == 'true' }}
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore(script): apply automatic changes"
          file_pattern: data_afmps/*.json *.xlsx
          commit_user_name: "BE pharmacies list updater Bot"
      - name: 💤 Skip job
        if: ${{ steps.git_diff.outputs.data == 'false' }}
        run: echo "No modified / added JSON file - See you later"